name: ðŸ–¥ Build Horizon Thin Client ISO
on:
  workflow_dispatch:
  push:
    branches: [master]

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: ðŸ“¥ Checkout code (with LFS)
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: ðŸ›  Install live-build and tools
        run: |
          sudo apt update
          sudo apt install -y live-build xorriso

      - name: ðŸ” Verify lb command exists
        run: |
          which lb || { echo "âŒ live-build not installed"; exit 1; }
          lb --version

      - name: ðŸ“¦ Check Horizon .deb present
        run: |
          ls -lh config/packages.chroot/
          if [ ! -f config/packages.chroot/VMware-Horizon-Client-*.deb ]; then
            echo "âŒ ERROR: Horizon .deb missing in config/packages.chroot/"
            echo "ðŸ’¡ Hint: Use Git LFS and ensure 'lfs: true' in checkout"
            exit 1
          fi

      - name: âš™ï¸ Configure live-build (GRUB only)
        run: |
          # Clean up any existing config to avoid conflicts
          rm -rf config/auto config/package-lists/*.list.binary config/package-lists/*.list.chroot_auto 2>/dev/null || true

          # Debug: Check what's in config before lb config
          echo "=== Config before lb config ==="
          find config -type f 2>/dev/null | sort || true

          lb config \
            --distribution jammy \
            --architectures amd64 \
            --bootloader grub \
            --syslinux-theme none \
            --gfxboot false \
            --archive-areas "main restricted universe multiverse" \
            --bootappend-live "boot=live quiet splash nomodeset" \
            --package-lists "horizon"

      - name: ðŸ§ª Debug config
        run: |
          echo "=== Checking config/binary ==="
          cat config/binary || true
          echo ""
          echo "=== Checking package lists ==="
          ls -la config/package-lists/ || true
          echo ""
          echo "=== Checking for auto package in lists ==="
          grep -r "auto" config/package-lists/ || echo "No 'auto' found in package lists"
          echo ""
          echo "=== All package list files ==="
          find config/package-lists/ -type f -name "*.list.*" 2>/dev/null | while read file; do
            echo "=== $file ==="
            cat "$file"
            echo ""
          done || true
          echo ""
          echo "=== Checking for auto in all config files ==="
          find config -type f -exec grep -l "auto" {} \; 2>/dev/null || echo "No files contain 'auto'"
          echo ""
          echo "=== Checking what 'auto' directory contains ==="
          ls -la config/auto/ 2>/dev/null || echo "No config/auto directory"

      - name: ðŸ— Build ISO
        run: |
          echo "ðŸš€ Starting build..."
          echo "=== Debug: Checking all package list files before build ==="
          find config/package-lists/ -type f -name "*.list.*" -exec sh -c 'echo "=== {} ==="; cat {}' \; 2>/dev/null || true
          echo ""
          echo "=== Creating empty package list to override any defaults ==="
          echo "# Empty package list" > config/package-lists/empty.list.chroot
          echo "# Empty binary package list" > config/package-lists/empty.list.binary
          echo ""
          echo "=== Checking if 'auto' is a directory or file ==="
          find config -name "*auto*" -type f 2>/dev/null || echo "No files with 'auto' in name"
          find config -name "*auto*" -type d 2>/dev/null || echo "No directories with 'auto' in name"
          echo ""
          echo "=== Starting lb build with verbose output ==="
          time sudo lb build --verbose

      - name: ðŸ“¤ Upload ISO
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: horizon-thin-client.iso
          path: live-image-amd64.hybrid.iso

      - name: ðŸ“Š Summary
        if: always()
        run: |
          echo "âœ… Done at $(date)"
          ls -lh live-image-amd64.hybrid.iso 2>/dev/null || echo "âš  ISO not found"
