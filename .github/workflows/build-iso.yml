name: ðŸ–¥ Build Horizon Thin Client ISO
on:
  workflow_dispatch:
  push:
    branches: [master]

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - name: ðŸ“¥ Checkout code (with LFS)
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: ðŸ›  Install build tools
        run: |
          sudo apt update
          sudo apt install -y \
            debootstrap \
            squashfs-tools \
            xorriso \
            syslinux-utils \
            isolinux \
            grub-efi-amd64 \
            grub-pc \
            wget

      - name: ðŸ“¦ Check Horizon .deb present
        run: |
          ls -lh config/packages.chroot/
          if [ ! -f config/packages.chroot/VMware-Horizon-Client-*.deb ]; then
            echo "âŒ ERROR: Horizon .deb missing in config/packages.chroot/"
            echo "ðŸ’¡ Hint: Use Git LFS and ensure 'lfs: true' in checkout"
            exit 1
          fi

      - name: ðŸ—ï¸ Create chroot environment
        run: |
          echo "=== Creating chroot environment ==="
          sudo mkdir -p /tmp/horizon-chroot

          # Bootstrap Ubuntu 24.04 (noble)
          sudo debootstrap \
            --arch=amd64 \
            noble \
            /tmp/horizon-chroot \
            https://archive.ubuntu.com/ubuntu/

          echo "Chroot created successfully"

      - name: âš™ï¸ Configure chroot
        run: |
          echo "=== Configuring chroot ==="

          # Mount proc for chroot operations
          sudo mount -t proc proc /tmp/horizon-chroot/proc
          sudo mount -t sysfs sys /tmp/horizon-chroot/sys
          sudo mount -o bind /dev /tmp/horizon-chroot/dev

          # Copy Horizon .deb to chroot
          sudo cp config/packages.chroot/VMware-Horizon-Client-*.deb /tmp/horizon-chroot/tmp/

          # Create setup script using echo commands
          echo '#!/bin/bash' > /tmp/setup.sh
          echo 'set -e' >> /tmp/setup.sh
          echo '' >> /tmp/setup.sh
          echo '# Configure apt sources' >> /tmp/setup.sh
          echo 'cat > /etc/apt/sources.list << "SOURCES_EOF"' >> /tmp/setup.sh
          echo 'deb https://archive.ubuntu.com/ubuntu noble main restricted universe multiverse' >> /tmp/setup.sh
          echo 'deb https://archive.ubuntu.com/ubuntu noble-updates main restricted universe multiverse' >> /tmp/setup.sh
          echo 'deb https://security.ubuntu.com/ubuntu noble-security main restricted universe multiverse' >> /tmp/setup.sh
          echo 'SOURCES_EOF' >> /tmp/setup.sh
          echo '' >> /tmp/setup.sh
          echo '# Update package lists' >> /tmp/setup.sh
          echo 'apt-get update' >> /tmp/setup.sh
          echo '' >> /tmp/setup.sh
          echo '# Install packages from list' >> /tmp/setup.sh
          echo 'while read pkg; do' >> /tmp/setup.sh
          echo '  if [ -n "$pkg" ]; then' >> /tmp/setup.sh
          echo '    apt-get install -y --no-install-recommends "$pkg" || echo "Failed to install $pkg, continuing..."' >> /tmp/setup.sh
          echo '  fi' >> /tmp/setup.sh
          echo 'done < /tmp/packages.list' >> /tmp/setup.sh
          echo '' >> /tmp/setup.sh
          echo '# Install Horizon Client' >> /tmp/setup.sh
          echo 'dpkg -i /tmp/VMware-Horizon-Client-*.deb || apt-get install -f -y' >> /tmp/setup.sh
          echo '' >> /tmp/setup.sh
          echo '# Create user' >> /tmp/setup.sh
          echo 'useradd -m -s /bin/bash horizon' >> /tmp/setup.sh
          echo 'echo "horizon:horizon" | chpasswd' >> /tmp/setup.sh
          echo 'usermod -aG sudo horizon' >> /tmp/setup.sh
          echo '' >> /tmp/setup.sh
          echo '# Clean up' >> /tmp/setup.sh
          echo 'apt-get clean' >> /tmp/setup.sh
          echo 'rm -rf /var/lib/apt/lists/* /tmp/*' >> /tmp/setup.sh

          # Copy package list and setup script
          sudo cp config/package-lists/horizon.list.chroot /tmp/horizon-chroot/tmp/packages.list
          sudo cp /tmp/setup.sh /tmp/horizon-chroot/tmp/
          sudo chmod +x /tmp/horizon-chroot/tmp/setup.sh

          # Run setup in chroot
          sudo chroot /tmp/horizon-chroot /tmp/setup.sh

          # Copy existing config files
          sudo cp -r config/includes.chroot/* /tmp/horizon-chroot/ 2>/dev/null || true

          # Unmount
          sudo umount /tmp/horizon-chroot/dev
          sudo umount /tmp/horizon-chroot/sys
          sudo umount /tmp/horizon-chroot/proc

      - name: ðŸ“ Prepare ISO filesystem
        run: |
          echo "=== Preparing ISO filesystem ==="

          # Create ISO directory structure
          mkdir -p /tmp/iso/{boot/grub,casper,isolinux}

          # Create squashfs filesystem
          sudo mksquashfs /tmp/horizon-chroot /tmp/iso/casper/filesystem.squashfs -comp xz -noappend

          # Copy kernel and initrd
          sudo cp /tmp/horizon-chroot/boot/vmlinuz-* /tmp/iso/casper/vmlinuz 2>/dev/null || echo "Warning: No kernel found"
          sudo cp /tmp/horizon-chroot/boot/initrd.img-* /tmp/iso/casper/initrd 2>/dev/null || echo "Warning: No initrd found"

          # Copy boot files
          cp /usr/lib/ISOLINUX/isolinux.bin /tmp/iso/isolinux/
          cp /usr/lib/syslinux/modules/bios/ldlinux.c32 /tmp/iso/isolinux/

          # Create isolinux config
          echo 'DEFAULT live' > /tmp/iso/isolinux/isolinux.cfg
          echo 'LABEL live' >> /tmp/iso/isolinux/isolinux.cfg
          echo '  menu label ^Horizon Thin Client' >> /tmp/iso/isolinux/isolinux.cfg
          echo '  kernel /casper/vmlinuz' >> /tmp/iso/isolinux/isolinux.cfg
          echo '  append initrd=/casper/initrd boot=casper quiet splash --' >> /tmp/iso/isolinux/isolinux.cfg
          echo 'PROMPT 0' >> /tmp/iso/isolinux/isolinux.cfg
          echo 'TIMEOUT 50' >> /tmp/iso/isolinux/isolinux.cfg

          # Create GRUB config
          mkdir -p /tmp/iso/boot/grub
          echo 'set default=0' > /tmp/iso/boot/grub/grub.cfg
          echo 'set timeout=5' >> /tmp/iso/boot/grub/grub.cfg
          echo '' >> /tmp/iso/boot/grub/grub.cfg
          echo 'menuentry "Horizon Thin Client" {' >> /tmp/iso/boot/grub/grub.cfg
          echo '  linux /casper/vmlinuz boot=casper quiet splash --' >> /tmp/iso/boot/grub/grub.cfg
          echo '  initrd /casper/initrd' >> /tmp/iso/boot/grub/grub.cfg
          echo '}' >> /tmp/iso/boot/grub/grub.cfg

          # Create disk info
          mkdir -p /tmp/iso/.disk
          echo "Horizon Thin Client 24.04" > /tmp/iso/.disk/info

      - name: ðŸš€ Create bootable ISO
        run: |
          echo "=== Creating bootable ISO ==="

          # Create ISO with xorriso
          xorriso -as mkisofs \
            -iso-level 3 \
            -full-iso9660-filenames \
            -volid "HORIZON_TC" \
            -output "horizon-thin-client.iso" \
            -eltorito-boot isolinux/isolinux.bin \
            -no-emul-boot -boot-load-size 4 -boot-info-table \
            -isohybrid-mbr /usr/lib/ISOLINUX/isohdpfx.bin \
            /tmp/iso

          # Make hybrid for USB
          if command -v isohybrid >/dev/null 2>&1; then
            echo "Making ISO hybrid for USB..."
            isohybrid horizon-thin-client.iso
          else
            echo "isohybrid not found, creating regular ISO"
          fi

          echo "ISO created: horizon-thin-client.iso"
          ls -lh horizon-thin-client.iso

      - name: ðŸ“¤ Upload ISO
        uses: actions/upload-artifact@v4
        with:
          name: horizon-thin-client.iso
          path: horizon-thin-client.iso

      - name: ðŸ“Š Summary
        if: always()
        run: |
          echo "âœ… Build completed at $(date)"
          if [ -f "horizon-thin-client.iso" ]; then
            echo "ðŸ“¦ ISO size: $(du -h horizon-thin-client.iso | cut -f1)"
            echo "ðŸ”§ ISO info:"
            file horizon-thin-client.iso
            echo "âœ… ISO successfully created!"
          else
            echo "âš  ISO not found"
            echo "Checking /tmp/iso directory:"
            ls -la /tmp/iso/ 2>/dev/null || echo "No /tmp/iso directory"
          fi
