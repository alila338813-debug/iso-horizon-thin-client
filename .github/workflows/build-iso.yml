name: ðŸ–¥ Build Horizon Thin Client ISO
on:
  workflow_dispatch:
  push:
    branches: [master]

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: ðŸ“¥ Checkout code (with LFS)
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: ðŸ›  Install and upgrade live-build
        run: |
          sudo apt update
          sudo apt install -y live-build xorriso
          # å°è¯•å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬
          sudo apt upgrade -y live-build || true
          # æ£€æŸ¥ç‰ˆæœ¬å’Œè¯¦ç»†ä¿¡æ¯
          echo "=== Live-build version info ==="
          lb --version
          echo ""
          echo "=== System information ==="
          echo "Ubuntu version:"
          lsb_release -a || cat /etc/os-release
          echo ""
          echo "=== Checking for auto package in repositories ==="
          apt-cache search ^auto$ 2>/dev/null || echo "No exact 'auto' package found"
          echo ""
          echo "=== Checking live-build configuration ==="
          find /usr/share/live-build -name "*auto*" -type f 2>/dev/null | head -10 || echo "No auto files in live-build"

      - name: ðŸ” Verify lb command exists
        run: |
          which lb || { echo "âŒ live-build not installed"; exit 1; }
          lb --version

      - name: ðŸ“¦ Check Horizon .deb present
        run: |
          ls -lh config/packages.chroot/
          if [ ! -f config/packages.chroot/VMware-Horizon-Client-*.deb ]; then
            echo "âŒ ERROR: Horizon .deb missing in config/packages.chroot/"
            echo "ðŸ’¡ Hint: Use Git LFS and ensure 'lfs: true' in checkout"
            exit 1
          fi

      - name: âš™ï¸ Configure live-build
        run: |
          # Clean up any existing config
          rm -rf config/auto config/package-lists/*.list.binary config/package-lists/*.list.chroot_auto 2>/dev/null || true

          # Use minimal lb config with all auto features disabled
          lb config \
            --distribution jammy \
            --architectures amd64 \
            --bootloader grub \
            --archive-areas "main restricted universe multiverse" \
            --bootappend-live "boot=live quiet splash nomodeset"

      - name: ðŸ§ª Configure package lists
        run: |
          # ç¡®ä¿åŒ…åˆ—è¡¨ç›®å½•å­˜åœ¨
          mkdir -p config/package-lists

          # åˆ›å»ºäºŒè¿›åˆ¶åŒ…åˆ—è¡¨
          echo "live-boot" > config/package-lists/horizon.list.binary

          # æ£€æŸ¥å¹¶ä¿®å¤ä»»ä½•åŒ…å« "auto" çš„åŒ…åˆ—è¡¨
          echo "=== Checking for 'auto' in package lists ==="
          find config/package-lists/ -type f -name "*.list.*" 2>/dev/null | while read file; do
            if grep -q "^auto$" "$file" || grep -q "^auto " "$file"; then
              echo "Removing 'auto' from $file"
              grep -v "^auto$" "$file" | grep -v "^auto " > "${file}.fixed"
              mv "${file}.fixed" "$file"
            fi
          done

          # åˆ›å»ºç©ºåŒ…åˆ—è¡¨ä»¥è¦†ç›–ä»»ä½•é»˜è®¤è®¾ç½®
          echo "# Empty package list" > config/package-lists/empty.list.chroot
          echo "# Empty binary package list" > config/package-lists/empty.list.binary

          # è®¾ç½®åŒ…åˆ—è¡¨é…ç½® - ç¦ç”¨æ‰€æœ‰è‡ªåŠ¨åŠŸèƒ½
          echo 'LB_PACKAGE_LISTS="horizon empty"' >> config/binary
          echo 'LB_APT_INDICES="false"' >> config/binary
          echo 'LB_APT_RECOMMENDS="false"' >> config/binary
          echo 'LB_APT_AUTOREMOVE="false"' >> config/binary
          echo 'LB_APT_AUTOCLEAN="false"' >> config/binary
          echo 'LB_DEBIAN_INSTALLER="false"' >> config/binary
          echo 'LB_DEBIAN_INSTALLER_TITLE=""' >> config/binary
          echo 'LB_INITRAMFS="none"' >> config/binary

      - name: ðŸ§ª Verify config before build
        run: |
          echo "=== Verifying configuration ==="
          echo "config/binary content:"
          cat config/binary
          echo ""
          echo "Package lists:"
          ls -la config/package-lists/
          echo ""
          echo "Checking for 'auto' in package lists:"
          grep -r "auto" config/package-lists/ || echo "No 'auto' found"
          echo ""
          echo "Checking for auto-generated package lists:"
          find config/package-lists/ -name "*auto*" -type f 2>/dev/null || echo "No auto-generated lists found"
          echo ""
          echo "All package list contents:"
          find config/package-lists/ -type f -name "*.list.*" -exec sh -c 'echo "=== {} ==="; cat {}' \; 2>/dev/null || true

      - name: ðŸ— Build ISO
        run: |
          echo "ðŸš€ Starting build..."
          echo "=== Final check before build ==="
          echo "Removing any auto-generated package lists..."
          rm -f config/package-lists/*.list.chroot_auto config/package-lists/*.list.binary_auto 2>/dev/null || true
          echo ""
          echo "=== Disabling all auto features ==="
          # ç¦ç”¨æ‰€æœ‰å¯èƒ½çš„è‡ªåŠ¨åŠŸèƒ½
          echo 'LB_AUTO="false"' >> config/binary
          echo 'LB_MODE="debian"' >> config/binary
          echo 'LB_PARENTS="false"' >> config/binary
          echo 'LB_SOURCE="false"' >> config/binary
          echo ""
          echo "=== Checking if auto is a live-build bug ==="
          # æ£€æŸ¥æ˜¯å¦æ˜¯å·²çŸ¥çš„ live-build bug
          echo "Searching for auto in live-build scripts..."
          grep -r "package.*auto" /usr/share/live-build /usr/lib/live-build 2>/dev/null | head -5 || echo "No auto package references found"
          echo ""
          echo "=== Creating mandatory auto package ==="
          # åˆ›å»ºä¸€ä¸ªå¿…é¡»çš„ auto è™šæ‹ŸåŒ…
          mkdir -p config/packages.chroot/auto-pkg/DEBIAN
          echo "Package: auto" > config/packages.chroot/auto-pkg/DEBIAN/control
          echo "Version: 1.0-1" >> config/packages.chroot/auto-pkg/DEBIAN/control
          echo "Architecture: all" >> config/packages.chroot/auto-pkg/DEBIAN/control
          echo "Maintainer: Horizon TC <horizon@example.com>" >> config/packages.chroot/auto-pkg/DEBIAN/control
          echo "Description: Mandatory auto package for live-build" >> config/packages.chroot/auto-pkg/DEBIAN/control
          echo "Priority: required" >> config/packages.chroot/auto-pkg/DEBIAN/control
          echo "Essential: yes" >> config/packages.chroot/auto-pkg/DEBIAN/control
          dpkg-deb --build config/packages.chroot/auto-pkg config/packages.chroot/auto_1.0-1_all.deb
          echo ""
          echo "=== Adding auto to package list ==="
          echo "auto" >> config/package-lists/horizon.list.chroot
          echo ""
          echo "=== Final system check ==="
          echo "Checking Ubuntu repository configuration..."
          grep -r "jammy" /etc/apt/sources.list* 2>/dev/null | head -3 || echo "No jammy sources found"
          echo ""
          echo "=== Starting lb build with more debugging ==="
          # å¯ç”¨è¯¦ç»†è¾“å‡ºä»¥æŸ¥çœ‹å…·ä½“é”™è¯¯
          set -x
          time sudo lb build --verbose 2>&1 | tee build.log
          set +x
          echo ""
          echo "=== Checking build log for errors ==="
          grep -n -B3 -A3 "auto" build.log || echo "No auto references in build log"
          echo ""
          echo "If build failed with auto error, this is likely a live-build bug."

      - name: ðŸ“¤ Upload ISO
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: horizon-thin-client.iso
          path: live-image-amd64.hybrid.iso

      - name: ðŸ“Š Summary
        if: always()
        run: |
          echo "âœ… Done at $(date)"
          ls -lh live-image-amd64.hybrid.iso 2>/dev/null || echo "âš  ISO not found"
