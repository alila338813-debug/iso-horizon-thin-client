name: ðŸ–¥ Build Horizon Thin Client ISO
on:
  workflow_dispatch:
  push:
    branches: [master]

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: ðŸ“¥ Checkout code (with LFS)
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: ðŸ›  Install live-build and fix apt sources
        run: |
          # ä¿®å¤ apt æºä»¥é¿å… Release æ–‡ä»¶é”™è¯¯
          echo "=== Fixing apt sources to avoid Release file errors ==="
          sudo sed -i 's|http://security.ubuntu.com/ubuntu|https://security.ubuntu.com/ubuntu|g' /etc/apt/sources.list
          sudo sed -i 's|http://archive.ubuntu.com/ubuntu|https://archive.ubuntu.com/ubuntu|g' /etc/apt/sources.list

          sudo apt update
          sudo apt install -y live-build xorriso
          lb --version

      - name: ðŸ” Verify lb command exists
        run: |
          which lb || { echo "âŒ live-build not installed"; exit 1; }
          lb --version

      - name: ðŸ“¦ Check Horizon .deb present
        run: |
          ls -lh config/packages.chroot/
          if [ ! -f config/packages.chroot/VMware-Horizon-Client-*.deb ]; then
            echo "âŒ ERROR: Horizon .deb missing in config/packages.chroot/"
            echo "ðŸ’¡ Hint: Use Git LFS and ensure 'lfs: true' in checkout"
            exit 1
          fi

      - name: âš™ï¸ Configure live-build
        run: |
          # æ¸…ç†çŽ°æœ‰é…ç½®
          rm -rf config/auto config/package-lists/*.list.binary config/package-lists/*.list.chroot_auto 2>/dev/null || true

          # ä½¿ç”¨æœ€å°é…ç½®
          lb config \
            --distribution jammy \
            --architectures amd64 \
            --bootloader grub \
            --archive-areas "main restricted universe multiverse" \
            --bootappend-live "boot=live quiet splash nomodeset"

      - name: ðŸ§ª Configure package lists
        run: |
          # ç¡®ä¿åŒ…åˆ—è¡¨ç›®å½•å­˜åœ¨
          mkdir -p config/package-lists

          # åˆ›å»ºäºŒè¿›åˆ¶åŒ…åˆ—è¡¨
          echo "live-boot" > config/package-lists/horizon.list.binary

          # åˆ›å»ºç©ºåŒ…åˆ—è¡¨ä»¥è¦†ç›–é»˜è®¤è®¾ç½®
          echo "# Empty package list" > config/package-lists/empty.list.chroot
          echo "# Empty binary package list" > config/package-lists/empty.list.binary

          # è®¾ç½®åŒ…åˆ—è¡¨é…ç½®
          echo 'LB_PACKAGE_LISTS="horizon empty"' >> config/binary
          echo 'LB_APT_INDICES="false"' >> config/binary
          echo 'LB_APT_RECOMMENDS="false"' >> config/binary

      - name: ðŸ§ª Verify config before build
        run: |
          echo "=== Verifying configuration ==="
          echo "config/binary content:"
          cat config/binary
          echo ""
          echo "Package lists:"
          ls -la config/package-lists/

      - name: ðŸ— Build ISO
        run: |
          echo "ðŸš€ Starting build..."
          echo "=== Final configuration ==="
          cat config/binary
          echo ""
          echo "=== Starting lb build ==="
          time sudo lb build

      - name: ðŸ“¤ Upload ISO
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: horizon-thin-client.iso
          path: live-image-amd64.hybrid.iso

      - name: ðŸ“Š Summary
        if: always()
        run: |
          echo "âœ… Done at $(date)"
          ls -lh live-image-amd64.hybrid.iso 2>/dev/null || echo "âš  ISO not found"
