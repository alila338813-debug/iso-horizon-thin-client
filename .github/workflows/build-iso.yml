name: üñ•Ô∏è Build Horizon Thin Client ISO
on:
  workflow_dispatch:  # ÊâãÂä®Ëß¶Âèë
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: üì• Checkout code (with LFS)
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: üõ†Ô∏è Install live-build and tools
        run: |
          sudo apt update
          sudo apt install -y live-build xorriso

      - name: üîç Verify lb command exists
        run: |
          which lb || { echo "‚ùå live-build not installed"; exit 1; }
          lb --version

      - name: üì¶ Check Horizon .deb present
        run: |
          ls -lh config/packages.chroot/
          if [ ! -f config/packages.chroot/VMware-Horizon-Client-*.deb ]; then
            echo "‚ùå ERROR: Horizon .deb missing in config/packages.chroot/"
            echo "üí° Hint: Use Git LFS and ensure 'lfs: true' in checkout"
            exit 1
          fi

      - name: ‚öôÔ∏è Configure live-build (GRUB only, Ubuntu 22.04 compatible)
        run: |
          # Primary method: lb config with correct params
          lb config \
            --distribution jammy \
            --architectures amd64 \
            --bootloader grub \
            --syslinux-themes none \
            --archive-areas "main restricted universe multiverse" \
            --bootappend-live "boot=live quiet splash nomodeset video=1024x768"
          
          # Fallback: manually enforce config (double insurance)
          mkdir -p config
          cat > config/binary <<'EOF'
LB_BOOTLOADER="grub"
LB_SYSLINUX_THEMES="none"
EOF

      - name: üß™ Debug: Verify config applied
        run: |
          echo "=== config/binary content ==="
          cat config/binary
          echo "=== End ==="

      - name: üèóÔ∏è Build ISO
        run: |
          echo "üöÄ Starting build (takes ~20 mins)..."
          time sudo lb build

      - name: üì§ Upload ISO Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: horizon-thin-client.iso
          path: live-image-amd64.hybrid.iso
          retention-days: 7

      - name: üìä Build Summary
        if: always()
        run: |
          echo "‚úÖ Build completed at $(date)"
          ls -lh live-image-amd64.hybrid.iso 2>/dev/null || echo "‚ö†Ô∏è ISO not found"
