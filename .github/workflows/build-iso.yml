name: ðŸ–¥ Build Horizon Thin Client ISO
on:
  workflow_dispatch:
  push:
    branches: [master]

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - name: ðŸ“¥ Checkout code (with LFS)
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: ðŸ›  Install live-build and fix apt sources
        run: |
          # å®‰è£…å¿…è¦çš„æž„å»ºå·¥å…·
          echo "=== Installing build tools ==="
          sudo apt update
          sudo apt install -y live-build xorriso syslinux-utils mtools
          # éªŒè¯ isohybrid å‘½ä»¤æ˜¯å¦å­˜åœ¨
          which isohybrid || echo "Checking for isohybrid..."
          find /usr -name "isohybrid" -type f 2>/dev/null | head -5 || echo "Will install syslinux-utils in chroot"
          # éªŒè¯ Ubuntu 24.04 åŒ…å
          echo "=== Checking package names in Ubuntu 24.04 ==="
          apt-cache show libglib2.0-0t64 2>/dev/null | grep -q "Package:" && echo "libglib2.0-0t64 exists" || echo "libglib2.0-0t64 not found"
          apt-cache show libssl3t64 2>/dev/null | grep -q "Package:" && echo "libssl3t64 exists" || echo "libssl3t64 not found"
          apt-cache show libglib2.0-0 2>/dev/null | grep -q "Package:" && echo "libglib2.0-0 exists" || echo "libglib2.0-0 not found"
          apt-cache show libssl3 2>/dev/null | grep -q "Package:" && echo "libssl3 exists" || echo "libssl3 not found"
          lb --version

      - name: ðŸ” Verify lb command exists
        run: |
          which lb || { echo "âŒ live-build not installed"; exit 1; }
          lb --version

      - name: ðŸ“¦ Check Horizon .deb present
        run: |
          ls -lh config/packages.chroot/
          if [ ! -f config/packages.chroot/VMware-Horizon-Client-*.deb ]; then
            echo "âŒ ERROR: Horizon .deb missing in config/packages.chroot/"
            echo "ðŸ’¡ Hint: Use Git LFS and ensure 'lfs: true' in checkout"
            exit 1
          fi

      - name: âš™ï¸ Configure live-build
        run: |
          # æ¸…ç†çŽ°æœ‰é…ç½®
          rm -rf config/auto config/package-lists/*.list.binary config/package-lists/*.list.chroot_auto 2>/dev/null || true

          # ä½¿ç”¨ Ubuntu 24.04 (noble) é…ç½® - åˆ›å»ºæ··åˆå¼•å¯¼ ISO
          lb config \
            --distribution noble \
            --architectures amd64 \
            --bootloader grub \
            --archive-areas "main restricted universe multiverse" \
            --bootappend-live "boot=live quiet splash nomodeset" \
            --mirror-bootstrap "https://archive.ubuntu.com/ubuntu/" \
            --mirror-chroot "https://archive.ubuntu.com/ubuntu/" \
            --mirror-chroot-security "https://security.ubuntu.com/ubuntu/" \
            --security false \
            --binary-images iso-hybrid \
            --debian-installer live

      - name: ðŸ§ª Configure package lists
        run: |
          # ç¡®ä¿åŒ…åˆ—è¡¨ç›®å½•å­˜åœ¨
          mkdir -p config/package-lists

          # åˆ›å»ºäºŒè¿›åˆ¶åŒ…åˆ—è¡¨
          echo "live-boot" > config/package-lists/horizon.list.binary

          # åˆ›å»ºç©ºåŒ…åˆ—è¡¨ä»¥è¦†ç›–é»˜è®¤è®¾ç½®
          echo "# Empty package list" > config/package-lists/empty.list.chroot
          echo "# Empty binary package list" > config/package-lists/empty.list.binary

          # ç¡®ä¿ GRUB åŒ…åœ¨åŒ…åˆ—è¡¨ä¸­ï¼ˆä¿®å¤ grub-legacy é”™è¯¯ï¼‰
          echo "=== Adding GRUB packages to horizon.list.chroot ==="
          if [ -f "config/package-lists/horizon.list.chroot" ]; then
            # æ·»åŠ æ­£ç¡®çš„ GRUB åŒ…
            echo "grub-pc" >> config/package-lists/horizon.list.chroot
            echo "grub-common" >> config/package-lists/horizon.list.chroot
            echo "grub2-common" >> config/package-lists/horizon.list.chroot
            # æ·»åŠ  syslinux-utils ç”¨äºŽ isohybrid
            echo "syslinux-utils" >> config/package-lists/horizon.list.chroot
            echo "mtools" >> config/package-lists/horizon.list.chroot
            echo "Added GRUB and USB boot packages to horizon.list.chroot"
          else
            echo "WARNING: horizon.list.chroot not found"
          fi

          # ä¿®å¤ chroot å†…çš„ apt æºé…ç½®
          echo "=== Fixing apt sources in chroot ==="
          mkdir -p config/archives
          # åˆ›å»ºæ­£ç¡®çš„ sources.list æ–‡ä»¶ (Ubuntu 24.04 noble)
          echo "deb https://archive.ubuntu.com/ubuntu noble main restricted universe multiverse" > config/archives/ubuntu.list.chroot
          echo "deb https://archive.ubuntu.com/ubuntu noble-updates main restricted universe multiverse" >> config/archives/ubuntu.list.chroot
          echo "deb https://security.ubuntu.com/ubuntu noble-security main restricted universe multiverse" >> config/archives/ubuntu.list.chroot
          # ç¡®ä¿ live-build ä½¿ç”¨æˆ‘ä»¬çš„æºæ–‡ä»¶
          echo 'LB_APT_SOURCE_ARCHIVES="ubuntu"' >> config/binary
          # ç¦ç”¨ security ä»“åº“çš„è‡ªåŠ¨æ£€æµ‹
          echo 'LB_SECURITY="false"' >> config/binary
          # ç¦ç”¨ apt æºçš„è‡ªåŠ¨æ›´æ–°
          echo 'LB_APT_SOURCES_LIST="false"' >> config/binary

          # è®¾ç½®åŒ…åˆ—è¡¨é…ç½®
          echo 'LB_PACKAGE_LISTS="horizon empty"' >> config/binary
          echo 'LB_APT_INDICES="false"' >> config/binary
          echo 'LB_APT_RECOMMENDS="false"' >> config/binary
          echo 'LB_APT_OPTIONS="--allow-unauthenticated"' >> config/binary
          # é…ç½®æ··åˆå¼•å¯¼æ”¯æŒ
          echo 'LB_GRUB_PACKAGES="grub-pc grub-efi-amd64"' >> config/binary
          echo 'LB_GRUB_INSTALL="grub-install"' >> config/binary
          echo 'LB_GRUB_MKCONFIG="grub-mkconfig"' >> config/binary
          # å¯ç”¨ UEFI å’Œ BIOS æ”¯æŒ
          echo 'LB_EFI="true"' >> config/binary
          echo 'LB_BIOS="true"' >> config/binary
          # å¯ç”¨ ISO hybrid åŠŸèƒ½ç”¨äºŽ USB å¯åŠ¨
          echo 'LB_ISO_HYBRID="true"' >> config/binary
          echo 'LB_BINARY_IMAGES="iso-hybrid"' >> config/binary
          echo 'LB_ISO_APPLICATION="Ubuntu Horizon Thin Client"' >> config/binary
          echo 'LB_ISO_PREPARER="live-build"' >> config/binary
          echo 'LB_ISO_PUBLISHER="Horizon TC Project"' >> config/binary
          # é…ç½®å¼•å¯¼å‚æ•°
          echo 'LB_BOOTLOADER="grub"' >> config/binary
          echo 'LB_SYSLINUX="false"' >> config/binary

      - name: ðŸ§ª Verify config before build
        run: |
          echo "=== Verifying configuration ==="
          echo "config/binary content:"
          cat config/binary
          echo ""
          echo "Package lists:"
          ls -la config/package-lists/

      - name: ðŸ— Build ISO
        run: |
          echo "ðŸš€ Starting build..."
          echo "=== Final configuration ==="
          cat config/binary
          echo ""
          echo "=== Checking apt sources in chroot ==="
          cat config/archives/ubuntu.list.chroot || echo "No ubuntu.list.chroot found"
          echo ""
          echo "=== Starting lb build with debugging ==="
          # æ£€æŸ¥å¼•å¯¼é…ç½®
          echo "Checking boot configuration..."
          ls -la config/boot* 2>/dev/null || echo "No boot config files found"
          # åˆ›å»ºå¿…è¦çš„å¼•å¯¼é…ç½®ç›®å½•
          mkdir -p config/includes.binary/isolinux
          echo ""
          echo "=== Final GRUB configuration check ==="
          grep -i grub config/binary || echo "No GRUB config found"
          echo ""
          echo "=== Checking package list before build ==="
          if [ -f "config/package-lists/horizon.list.chroot" ]; then
            echo "Current horizon.list.chroot contents:"
            cat config/package-lists/horizon.list.chroot
          fi
          echo ""
          echo "=== Final cleanup and verification ==="
          # æ¸…ç†è‡ªåŠ¨ç”Ÿæˆçš„åŒ…åˆ—è¡¨
          rm -f config/package-lists/*.list.chroot_auto config/package-lists/*.list.binary_auto 2>/dev/null || true
          # ç¡®ä¿ horizon.list.chroot åŒ…å«æ­£ç¡®çš„ GRUB åŒ…
          if [ -f "config/package-lists/horizon.list.chroot" ]; then
            echo "Adding both BIOS and UEFI GRUB packages"
            # ç§»é™¤çŽ°æœ‰çš„ GRUB åŒ…
            grep -v "^grub-" config/package-lists/horizon.list.chroot > config/package-lists/horizon.list.chroot.tmp
            mv config/package-lists/horizon.list.chroot.tmp config/package-lists/horizon.list.chroot
            # æ·»åŠ æ··åˆå¼•å¯¼åŒ…
            echo "grub-pc" >> config/package-lists/horizon.list.chroot
            echo "grub-efi-amd64" >> config/package-lists/horizon.list.chroot
            echo "grub-common" >> config/package-lists/horizon.list.chroot
            echo "grub2-common" >> config/package-lists/horizon.list.chroot
            echo "grub-efi-amd64-signed" >> config/package-lists/horizon.list.chroot
            echo "shim-signed" >> config/package-lists/horizon.list.chroot
            echo "efibootmgr" >> config/package-lists/horizon.list.chroot
          fi
          echo ""
          set -x
          time sudo lb build 2>&1 | tee build.log
          set +x
          echo ""
          echo "=== Build log summary ==="
          tail -100 build.log | grep -E "(Error|error|FAIL|fail|auto|Release|boot|isohybrid|grub)" || echo "No significant errors found"
          echo ""
          echo "=== Checking ISO file ==="
          ls -lh *.iso 2>/dev/null || echo "No ISO files found"
          if [ -f "live-image-amd64.hybrid.iso" ]; then
            echo "ISO file exists, checking boot info..."
            file live-image-amd64.hybrid.iso
            isoinfo -d -i live-image-amd64.hybrid.iso 2>/dev/null || echo "Cannot read ISO info"
          fi

      - name: ðŸ“¤ Upload ISO
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: horizon-thin-client.iso
          path: live-image-amd64.hybrid.iso

      - name: ðŸ“Š Summary
        if: always()
        run: |
          echo "âœ… Done at $(date)"
          ls -lh live-image-amd64.hybrid.iso 2>/dev/null || echo "âš  ISO not found"
